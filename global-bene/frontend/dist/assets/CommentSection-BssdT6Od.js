import{j as t}from"./ui-BaUVVAjf.js";import{r as d,L as E}from"./router-DiqerDgP.js";import{a as P}from"./index-DDEPdpRf.js";const u=P,h={getPostComments:o=>u.get(`/comments/post/${o}`),createComment:(o,n)=>u.post(`/comments/post/${o}`,n),voteComment:(o,n)=>u.post(`/comments/${o}/vote`,{voteType:n}),updateComment:(o,n)=>u.put(`/comments/${o}`,n),deleteComment:o=>u.delete(`/comments/${o}`)};function B({postId:o,onCommentUpdate:n}){const[x,f]=d.useState([]),[_,w]=d.useState(!1),[j,b]=d.useState(null),[g,N]=d.useState(""),[p,k]=d.useState(""),[m,v]=d.useState({}),r=(()=>{try{const s=sessionStorage.getItem("user");if(s){const e=JSON.parse(s);if(e&&e._id)return e._id}const l=sessionStorage.getItem("accessToken");if(l)try{const e=JSON.parse(atob(l.split(".")[1]));if(e&&e.id)return e.id}catch(e){console.warn("Failed to decode token:",e)}}catch(s){console.error("Error getting user info:",s)}return null})(),R=s=>{let l=0;const e=a=>{a.forEach(i=>{l++,i.replies&&i.replies.length>0&&e(i.replies)})};return e(s),l},y=async()=>{w(!0);try{const s=await h.getPostComments(o);f(s.data.comments||[])}catch{}w(!1)};d.useEffect(()=>{y()},[o]),d.useEffect(()=>{const s={},l=e=>{e.forEach(a=>{r&&(Array.isArray(a.upvotes)&&a.upvotes.some(i=>i.toString()===r.toString())?s[a._id]="upvote":Array.isArray(a.downvotes)&&a.downvotes.some(i=>i.toString()===r.toString())?s[a._id]="downvote":s[a._id]=null),a.replies&&l(a.replies)})};l(x),v(s)},[x,r]);const C=async(s,l)=>{if(!r)return alert("Login to vote!");try{const e=await h.voteComment(s,l);e?.data?.data?.userVote?v({...m,[s]:e.data.data.userVote==="up"?"upvote":"downvote"}):v({...m,[s]:null}),f(a=>{const i=$=>$.map(c=>c._id===s?{...c,upvotes:e.data.data.upvotes||[],downvotes:e.data.data.downvotes||[]}:c.replies&&c.replies.length>0?{...c,replies:i(c.replies)}:c);return i(a)})}catch(e){console.error("Vote error:",e)}},A=async s=>{if(g.trim())try{await h.createComment(o,{content:g,parentCommentId:s}),N(""),b(null),y(),n&&n()}catch{}},L=async()=>{if(p.trim()){if(!r)return alert("Please login to comment!");try{await h.createComment(o,{content:p}),k(""),y(),n&&n()}catch{alert("Failed to post comment. Please try again.")}}},S=(s,l=0)=>t.jsx("div",{className:`${l>0?"ml-2 sm:ml-4 md:ml-6 lg:ml-8 border-l-2 border-orange-200 pl-2 sm:pl-3 md:pl-4 lg:pl-5":""}`,children:s.map(e=>t.jsxs("div",{className:"mb-3 sm:mb-4 rounded-lg p-2 sm:p-3 md:p-4 bg-gray-50 dark:bg-gray-700 shadow-sm hover:shadow-md transition-shadow duration-200",children:[t.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center space-y-1 sm:space-y-0 sm:space-x-2 mb-2",children:[t.jsxs(E,{to:`/profile/${e.author?._id}`,className:"text-xs sm:text-sm font-semibold text-blue-600 dark:text-blue-400 hover:underline truncate",children:["u/",e.author?.username]}),t.jsx("span",{className:"text-xs text-gray-500 whitespace-nowrap",children:new Date(e.createdAt).toLocaleString()})]}),t.jsx("p",{className:"text-gray-700 dark:text-gray-300 text-sm sm:text-base mb-3 leading-relaxed break-words",children:e.content}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2 sm:gap-3 text-xs sm:text-sm text-gray-500",children:[t.jsxs("button",{onClick:()=>C(e._id,"upvote"),className:`flex items-center gap-1 px-2 py-1 rounded-md transition-all duration-200 transform hover:scale-110 ${m[e._id]==="upvote"?"text-orange-500 bg-orange-50 dark:bg-orange-900/20 shadow-md":r?"text-gray-400 hover:text-orange-500 hover:bg-gray-200 dark:hover:bg-gray-700":"text-gray-300 cursor-not-allowed"}`,disabled:!r,title:r?m[e._id]==="upvote"?"Remove upvote":"Upvote":"Login to upvote",children:[t.jsx("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20",children:t.jsx("path",{fillRule:"evenodd",d:"M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z",clipRule:"evenodd"})}),t.jsx("span",{className:"font-medium",children:Array.isArray(e.upvotes)?e.upvotes.length:e.upvotes||0})]}),t.jsxs("button",{onClick:()=>C(e._id,"downvote"),className:`flex items-center gap-1 px-2 py-1 rounded-md transition-all duration-200 transform hover:scale-110 ${m[e._id]==="downvote"?"text-blue-500 bg-blue-50 dark:bg-blue-900/20 shadow-md":r?"text-gray-400 hover:text-blue-500 hover:bg-gray-200 dark:hover:bg-gray-700":"text-gray-300 cursor-not-allowed"}`,disabled:!r,title:r?m[e._id]==="downvote"?"Remove downvote":"Downvote":"Login to downvote",children:[t.jsx("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20",children:t.jsx("path",{fillRule:"evenodd",d:"M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z",clipRule:"evenodd"})}),t.jsx("span",{className:"font-medium",children:Array.isArray(e.downvotes)?e.downvotes.length:e.downvotes||0})]}),t.jsx("button",{onClick:()=>b(j===e._id?null:e._id),className:"px-2 py-1 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors duration-200 hover:underline",disabled:!r,children:"Reply"})]}),j===e._id&&t.jsxs("div",{className:"mt-3 animate-in slide-in-from-top-2 duration-200",children:[t.jsx("textarea",{value:g,onChange:a=>N(a.target.value),placeholder:"Write a reply...",rows:3,className:"block w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm sm:text-base resize-y focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all duration-200",autoFocus:!0}),t.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 mt-2",children:[t.jsx("button",{onClick:()=>A(e._id),disabled:!g.trim(),className:"px-4 py-2 bg-orange-500 hover:bg-orange-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white rounded-lg font-medium transition-colors duration-200 text-sm sm:text-base",children:"Send Reply"}),t.jsx("button",{onClick:()=>b(null),className:"px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition-colors duration-200 text-sm sm:text-base",children:"Cancel"})]})]}),e.replies&&e.replies.length>0&&S(e.replies,l+1)]},e._id))});return t.jsxs("div",{className:"w-full max-w-4xl mx-auto px-2 sm:px-4",children:[t.jsxs("div",{className:"mb-4 sm:mb-6",children:[t.jsx("h4",{className:"font-bold text-base sm:text-lg md:text-xl mb-3 text-slate-700 dark:text-slate-100",children:"Add a Comment"}),t.jsx("textarea",{value:p,onChange:s=>k(s.target.value),placeholder:r?"Write a comment...":"Please login to comment",disabled:!r,rows:4,className:"w-full p-3 sm:p-4 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-orange-500 focus:border-transparent disabled:opacity-50 disabled:cursor-not-allowed resize-y text-sm sm:text-base transition-all duration-200"}),t.jsx("div",{className:"flex justify-end mt-3",children:t.jsx("button",{onClick:L,disabled:!r||!p.trim(),className:"px-4 sm:px-6 py-2 sm:py-3 bg-orange-500 hover:bg-orange-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white rounded-lg font-medium transition-all duration-200 transform hover:scale-105 active:scale-95 text-sm sm:text-base",children:"Post Comment"})})]}),t.jsxs("div",{children:[t.jsxs("h4",{className:"font-bold text-base sm:text-lg md:text-xl mb-3 sm:mb-4 text-slate-700 dark:text-slate-100",children:["All Comments (",R(x),")"]}),_?t.jsxs("div",{className:"flex items-center justify-center p-6 sm:p-8",children:[t.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500"}),t.jsx("span",{className:"ml-3 text-sm sm:text-base text-gray-500",children:"Loading comments..."})]}):x.length===0?t.jsxs("div",{className:"text-center p-6 sm:p-8 text-gray-500",children:[t.jsx("div",{className:"text-4xl sm:text-6xl mb-4",children:"ðŸ’¬"}),t.jsx("p",{className:"text-sm sm:text-base",children:"No comments yet. Be the first to comment!"})]}):t.jsx("div",{className:"space-y-2 sm:space-y-3",children:S(x)})]})]})}export{B as C,h as c};
